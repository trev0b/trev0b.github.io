<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flood Zone Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Proxima Nova', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #607D8B 0%, #90A4AE 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            min-width: 280px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .search-container {
            margin-bottom: 30px;
            position: relative;
        }

        .location-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .location-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #78909C 0%, #90A4AE 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .location-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(120, 144, 156, 0.3);
        }

        .location-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .divider {
            margin: 20px 0;
            text-align: center;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: #7f8c8d;
            font-size: 14px;
            position: relative;
        }

        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: #546E7A;
            box-shadow: 0 0 0 3px rgba(84, 110, 122, 0.1);
        }

        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .suggestions-dropdown.show {
            display: block;
        }

        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            font-size: 14px;
            line-height: 1.4;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background-color: #f8f9ff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-primary {
            font-weight: 600;
            color: #2c3e50;
        }

        .suggestion-secondary {
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 2px;
        }

        .loading-suggestions {
            padding: 12px 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }

        .no-suggestions {
            padding: 12px 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #546E7A 0%, #78909C 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(84, 110, 122, 0.3);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 15px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .result-container.show {
            display: block;
        }

        .result-yes {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            color: #c53030;
        }

        .result-moderate {
            background: #fff8e1;
            border: 2px solid #ffb74d;
            color: #e65100;
        }

        .result-no {
            background: #f0fff4;
            border: 2px solid #c6f6d5;
            color: #38a169;
        }

        .result-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .result-text {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .result-address {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .result-details {
            font-size: 0.9em;
            opacity: 0.7;
            line-height: 1.5;
        }

        .flash-flood-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .flash-flood-container.show {
            display: block;
        }

        .flash-flood-container.flash-risk-high {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            color: #c53030;
        }

        .flash-flood-container.flash-risk-moderate {
            background: #fff8e1;
            border: 2px solid #ffb74d;
            color: #e65100;
        }

        .flash-flood-container.flash-risk-low-moderate {
            background: #f3e5f5;
            border: 2px solid #ce93d8;
            color: #7b1fa2;
        }

        .flash-flood-container.flash-risk-low {
            background: #f0fff4;
            border: 2px solid #c6f6d5;
            color: #38a169;
        }

        .flash-flood-icon {
            font-size: 3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .flash-flood-section {
            padding: 0;
            border-radius: 0;
            border-left: none;
            background: transparent;
        }

        .flash-flood-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #e65100;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flash-flood-risk {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .flash-flood-risk-level {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .flash-risk-high {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .flash-risk-moderate {
            background: #fff8e1;
            color: #f57600;
            border: 1px solid #ffcc02;
        }

        .flash-risk-low-moderate {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #ce93d8;
        }

        .flash-risk-low {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .flash-flood-details {
            font-size: 0.9em;
            opacity: 0.7;
            line-height: 1.5;
        }

        .flash-flood-factors {
            margin: 12px 0;
        }

        .flash-flood-factors p {
            margin-bottom: 8px;
        }

        .flash-flood-recommendations {
            margin-top: 15px;
        }

        .flash-flood-recommendations p {
            margin-bottom: 4px;
        }

        .loading {
            display: none;
            margin-top: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #546E7A;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .disclaimer {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.5;
        }

        @media (max-width: 600px) {
            body {
                padding: 5px;
                min-height: auto;
            }
            
            .search-box {
                flex-direction: column;
                gap: 10px;
            }
            
            .container {
                padding: 20px 15px;
                border-radius: 15px;
                min-width: 260px;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 1em;
                margin-bottom: 20px;
            }
            
            .search-container {
                margin-bottom: 20px;
            }
            
            input[type="text"] {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .search-btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 100px;
            }

            .location-btn {
                padding: 10px 20px;
                font-size: 13px;
            }

            .flash-flood-risk {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .result-container {
                margin-top: 20px;
                padding: 15px;
            }
            
            .result-icon {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            
            .result-text {
                font-size: 1.1em;
                margin-bottom: 8px;
            }
            
            .result-address {
                font-size: 0.9em;
                margin-bottom: 12px;
            }
            
            .result-details {
                font-size: 0.85em;
                text-align: left;
            }
            
            .disclaimer {
                margin-top: 20px;
                padding: 15px;
                font-size: 0.85em;
                text-align: left;
            }
        }

        @media (max-width: 400px) {
            .container {
                padding: 15px 10px;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 1.6em;
            }
            
            .subtitle {
                font-size: 0.9em;
            }
            
            input[type="text"] {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .search-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        @media (max-height: 600px) {
            body {
                align-items: flex-start;
                padding-top: 10px;
            }
            
            .container {
                margin-top: 0;
            }
        }

        html, body {
            overflow-x: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌊 Flood Zone Checker</h1>
        <p class="subtitle">Enter an address to check if it's in a FEMA flood zone and to see if it has a risk of flash flooding</p>
        
        <div class="search-container">
            <div class="location-section">
                <button class="location-btn" id="locationBtn">
                    📍 Use My Current Location
                </button>
            </div>

            <div class="divider">
                <span>OR</span>
            </div>

            <div class="search-box">
                <div class="input-container">
                    <input type="text" id="addressInput" placeholder="Enter address (e.g., 100 Main St, Memphis, TN)" autocomplete="off" />
                    <div class="suggestions-dropdown" id="suggestionsDropdown"></div>
                </div>
                <button class="search-btn" id="searchBtn">Check Zone</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Checking flood zone status...</p>
        </div>

        <div class="result-container" id="resultContainer">
            <div class="result-icon" id="resultIcon"></div>
            <div class="result-text" id="resultText"></div>
            <div class="result-address" id="resultAddress"></div>
            <div class="result-details" id="resultDetails"></div>
        </div>

        <div class="flash-flood-container" id="flashFloodContainer">
            <div class="flash-flood-icon" id="flashFloodIcon">⚡</div>
            <div class="result-text" id="flashFloodTitle">Flash Flood Risk Assessment</div>
            <div class="result-address" id="flashFloodAddress"></div>
            <div class="flash-flood-section">
                <div class="flash-flood-details">
                    <div class="flash-flood-factors" id="flashFactors">
                        <div id="flashFactorsList"></div>
                    </div>
                    <div class="flash-flood-recommendations" id="flashRecommendations">
                        <div id="flashRecommendationsList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <strong>⚠️ Important Notes:</strong><br>
            • Results are based on official FEMA flood zone data when available<br>
            • For mortgage/insurance purposes, verify with <a href="https://msc.fema.gov/portal/search" target="_blank">FEMA's official tools</a><br>
            • This tool provides general information - consult professionals for official determinations
        </div>
    </div>

    <script>
        let suggestionsTimeout;
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;
        let isProcessing = false;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const addressInput = document.getElementById('addressInput');
            const searchBtn = document.getElementById('searchBtn');
            const locationBtn = document.getElementById('locationBtn');

            // Enter key support
            addressInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedSuggestionIndex >= 0 && currentSuggestions.length > 0) {
                        selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
                    } else {
                        checkFloodZone();
                    }
                }
            });

            // Keyboard navigation for suggestions
            addressInput.addEventListener('keydown', function(e) {
                const dropdown = document.getElementById('suggestionsDropdown');
                const suggestions = dropdown.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (selectedSuggestionIndex < suggestions.length - 1) {
                        selectedSuggestionIndex++;
                        updateSuggestionHighlight(suggestions);
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (selectedSuggestionIndex > 0) {
                        selectedSuggestionIndex--;
                        updateSuggestionHighlight(suggestions);
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });

            // Input event for suggestions
            addressInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                if (query.length < 3) {
                    hideSuggestions();
                    return;
                }
                
                if (suggestionsTimeout) {
                    clearTimeout(suggestionsTimeout);
                }
                
                suggestionsTimeout = setTimeout(() => {
                    fetchAddressSuggestions(query);
                }, 300);
            });

            // Button click events
            searchBtn.addEventListener('click', checkFloodZone);
            locationBtn.addEventListener('click', useCurrentLocation);

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                const inputContainer = document.querySelector('.input-container');
                if (!inputContainer.contains(e.target)) {
                    hideSuggestions();
                }
            });
        });

        async function fetchAddressSuggestions(query) {
            const dropdown = document.getElementById('suggestionsDropdown');
            
            try {
                dropdown.innerHTML = '<div class="loading-suggestions">🔍 Searching addresses...</div>';
                dropdown.classList.add('show');
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=us&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'FloodZoneChecker/1.0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Suggestions failed: ${response.status}`);
                }
                
                const suggestions = await response.json();
                displaySuggestions(suggestions);
                
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                dropdown.innerHTML = '<div class="no-suggestions">❌ Unable to load suggestions</div>';
            }
        }

        function displaySuggestions(suggestions) {
            const dropdown = document.getElementById('suggestionsDropdown');
            currentSuggestions = suggestions;
            selectedSuggestionIndex = -1;
            
            if (suggestions.length === 0) {
                dropdown.innerHTML = '<div class="no-suggestions">No addresses found</div>';
                return;
            }
            
            const suggestionItems = suggestions.map((suggestion, index) => {
                const address = suggestion.address || {};
                const primaryText = formatPrimaryAddress(address);
                const secondaryText = formatSecondaryAddress(address);
                
                return `
                    <div class="suggestion-item" onclick="selectSuggestion(currentSuggestions[${index}])">
                        <div class="suggestion-primary">${primaryText}</div>
                        <div class="suggestion-secondary">${secondaryText}</div>
                    </div>
                `;
            }).join('');
            
            dropdown.innerHTML = suggestionItems;
            dropdown.classList.add('show');
        }

        function formatPrimaryAddress(address) {
            const parts = [];
            if (address.house_number) parts.push(address.house_number);
            if (address.road) parts.push(address.road);
            return parts.join(' ') || address.display_name?.split(',')[0] || 'Unknown Address';
        }

        function formatSecondaryAddress(address) {
            const parts = [];
            if (address.city || address.town || address.village) {
                parts.push(address.city || address.town || address.village);
            }
            if (address.state) parts.push(address.state);
            if (address.postcode) parts.push(address.postcode);
            return parts.join(', ') || 'Location details unavailable';
        }

        function selectSuggestion(suggestion) {
            const input = document.getElementById('addressInput');
            const cleanAddress = formatCleanAddress(suggestion);
            input.value = cleanAddress;
            hideSuggestions();
            
            // Store suggestion data immediately
            input.selectedSuggestion = {
                lat: parseFloat(suggestion.lat),
                lon: parseFloat(suggestion.lon),
                display_name: cleanAddress,
                address: suggestion.address
            };
        }

        function formatCleanAddress(suggestion) {
            const address = suggestion.address || {};
            const parts = [];
            
            // Street address
            if (address.house_number && address.road) {
                parts.push(`${address.house_number} ${address.road}`);
            } else if (address.road) {
                parts.push(address.road);
            }
            
            // City
            if (address.city) {
                parts.push(address.city);
            } else if (address.town) {
                parts.push(address.town);
            } else if (address.village) {
                parts.push(address.village);
            }
            
            // State
            if (address.state) {
                parts.push(address.state);
            }
            
            // ZIP code
            if (address.postcode) {
                parts.push(address.postcode);
            }
            
            return parts.join(', ') || suggestion.display_name;
        }

        function updateSuggestionHighlight(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.classList.add('highlighted');
                } else {
                    item.classList.remove('highlighted');
                }
            });
        }

        function hideSuggestions() {
            const dropdown = document.getElementById('suggestionsDropdown');
            dropdown.classList.remove('show');
            selectedSuggestionIndex = -1;
        }

        async function useCurrentLocation() {
            const locationBtn = document.getElementById('locationBtn');
            const loading = document.getElementById('loading');
            const resultContainer = document.getElementById('resultContainer');
            const flashFloodContainer = document.getElementById('flashFloodContainer');

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            if (isProcessing) {
                return;
            }

            isProcessing = true;
            locationBtn.disabled = true;
            locationBtn.innerHTML = '🔄 Getting Location...';
            loading.classList.add('show');
            resultContainer.classList.remove('show');
            flashFloodContainer.classList.remove('show');

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false, // Changed from true - can be slower on mobile
                        timeout: 15000, // Increased from 10000
                        maximumAge: 600000 // Increased from 300000 (10 minutes)
                    });
                });

                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                const address = await reverseGeocode(lat, lon);
                const result = await checkFloodZoneByCoordinates(lat, lon);
                result.coordinates = `${lat.toFixed(8)}, ${lon.toFixed(8)}`;
                
                const flashFloodRisk = await assessFlashFloodRisk(lat, lon);
                result.flashFloodRisk = flashFloodRisk;
                
                const addressInput = document.getElementById('addressInput');
                if (address) {
                    addressInput.value = address;
                }
                
                displayResult(result, address || 'Your Current Location');

            } catch (error) {
                console.error('Location error:', error);
                let errorMessage = 'Unable to get your location. ';
                
                if (error.code === 1) {
                    errorMessage += 'Please allow location access and try again.';
                } else if (error.code === 2) {
                    errorMessage += 'Location information is unavailable.';
                } else if (error.code === 3) {
                    errorMessage += 'Location request timed out.';
                } else {
                    errorMessage += 'Please try entering your address manually.';
                }
                
                displayError(errorMessage);
            } finally {
                isProcessing = false;
                locationBtn.disabled = false;
                locationBtn.innerHTML = '📍 Use My Current Location';
                loading.classList.remove('show');
            }
        }

        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'FloodZoneChecker/1.0'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Reverse geocoding failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (data && data.address) {
                    const address = data.address;
                    const parts = [];
                    
                    if (address.house_number && address.road) {
                        parts.push(`${address.house_number} ${address.road}`);
                    } else if (address.road) {
                        parts.push(address.road);
                    }
                    
                    if (address.city) {
                        parts.push(address.city);
                    } else if (address.town) {
                        parts.push(address.town);
                    } else if (address.village) {
                        parts.push(address.village);
                    }
                    
                    if (address.state) {
                        parts.push(address.state);
                    }
                    
                    if (address.postcode) {
                        parts.push(address.postcode);
                    }
                    
                    return parts.join(', ') || data.display_name;
                }
                
                return null;
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return null;
            }
        }

        async function checkFloodZone() {
            if (isProcessing) {
                return;
            }
            
            const addressInput = document.getElementById('addressInput');
            let address = addressInput.value.trim();
            
            if (!address) {
                alert('Please enter an address');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const loading = document.getElementById('loading');
            const resultContainer = document.getElementById('resultContainer');
            const flashFloodContainer = document.getElementById('flashFloodContainer');
            
            isProcessing = true;
            hideSuggestions();
            
            searchBtn.disabled = true;
            searchBtn.textContent = 'Checking...';
            loading.classList.add('show');
            resultContainer.classList.remove('show');
            flashFloodContainer.classList.remove('show');

            try {
                let coords;
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                if (addressInput.selectedSuggestion && addressInput.selectedSuggestion.lat) {
                    coords = addressInput.selectedSuggestion;
                    address = coords.display_name;
                } else {
                    coords = await geocodeAddress(address);
                    if (!coords) {
                        throw new Error('Could not find coordinates for this address. Please try selecting from the suggestions or enter a more specific address.');
                    }
                }
                
                const result = await checkFloodZoneByCoordinates(coords.lat, coords.lon);
                result.coordinates = `${coords.lat.toFixed(8)}, ${coords.lon.toFixed(8)}`;
                
                const flashFloodRisk = await assessFlashFloodRisk(coords.lat, coords.lon);
                result.flashFloodRisk = flashFloodRisk;
                
                displayResult(result, address);
                
            } catch (error) {
                console.error('Error checking flood zone:', error);
                displayError(error.message || 'Please try again or check the address format.');
            } finally {
                isProcessing = false;
                searchBtn.disabled = false;
                searchBtn.textContent = 'Check Zone';
                loading.classList.remove('show');
                setTimeout(() => {
                    addressInput.selectedSuggestion = null;
                }, 100);
            }
        }

        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&countrycodes=us&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'FloodZoneChecker/1.0'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Geocoding failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (data && data.length > 0) {
                    const result = data[0];
                    return {
                        lat: parseFloat(result.lat),
                        lon: parseFloat(result.lon),
                        display_name: result.display_name,
                        address: result.address
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                throw new Error('Unable to find coordinates for this address');
            }
        }

        async function checkFloodZoneByCoordinates(lat, lon) {
            try {
                // Try FEMA ArcGIS REST Service
                const result = await queryFEMAArcGIS(lat, lon);
                if (result.success) {
                    return result.data;
                }
                
                // Fallback - return no data available
                return {
                    inFloodZone: false,
                    zone: 'Data Unavailable',
                    riskLevel: 'Unknown',
                    insuranceRequired: false,
                    source: 'No Data Available',
                    coordinates: `${lat.toFixed(8)}, ${lon.toFixed(8)}`,
                    hasFloodData: false,
                    zoneDescription: 'Unable to determine flood zone - FEMA data services not accessible',
                    error: 'Flood zone data services are currently unavailable. Please try again later.'
                };
                
            } catch (error) {
                console.error('Flood zone check error:', error);
                return {
                    inFloodZone: false,
                    zone: 'Error',
                    riskLevel: 'Unknown',
                    insuranceRequired: false,
                    source: 'Error',
                    coordinates: `${lat.toFixed(8)}, ${lon.toFixed(8)}`,
                    hasFloodData: false,
                    zoneDescription: 'Error retrieving flood zone data',
                    error: error.message || 'Unknown error occurred'
                };
            }
        }

        async function queryFEMAArcGIS(lat, lon) {
            try {
                const serviceUrl = 'https://hazards.fema.gov/arcgis/rest/services/public/NFHL/MapServer/28/query';
                const params = new URLSearchParams({
                    'f': 'json',
                    'where': '1=1',
                    'geometry': `${lon},${lat}`,
                    'geometryType': 'esriGeometryPoint',
                    'inSR': '4326',
                    'spatialRel': 'esriSpatialRelIntersects',
                    'outFields': 'FLD_ZONE,ZONE_SUBTY,SFHA_TF,STATIC_BFE,V_DATUM,DEPTH,VELOCITY',
                    'returnGeometry': 'false'
                });
                
                console.log('Calling FEMA API:', `${serviceUrl}?${params}`);
                console.log('User Agent:', navigator.userAgent);
                
                const response = await fetch(`${serviceUrl}?${params}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                        // Removed User-Agent header as it can cause issues on mobile
                    }
                });
                
                console.log('FEMA API Response Status:', response.status);
                
                if (!response.ok) {
                    console.error('FEMA API Error:', response.status, response.statusText);
                    throw new Error(`ArcGIS request failed: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('FEMA API Data:', data);
                
                if (data.features && data.features.length > 0) {
                    const attributes = data.features[0].attributes;
                    const zone = attributes.FLD_ZONE || 'Unknown';
                    const riskLevel = getFloodRiskLevel(zone);
                    const isInFloodZone = riskLevel === 'High' || riskLevel === 'Moderate';
                    
                    return {
                        success: true,
                        data: {
                            inFloodZone: isInFloodZone,
                            zone: zone,
                            riskLevel: riskLevel,
                            insuranceRequired: isInsuranceRequired(zone),
                            source: 'FEMA NFHL ArcGIS REST (Official)',
                            coordinates: `${lat.toFixed(8)}, ${lon.toFixed(8)}`,
                            hasFloodData: true,
                            zoneDescription: getZoneDescription(zone),
                            additionalInfo: {
                                subtype: attributes.ZONE_SUBTY,
                                sfha: attributes.SFHA_TF,
                                baseFloodElevation: attributes.STATIC_BFE,
                                datum: attributes.V_DATUM,
                                depth: attributes.DEPTH,
                                velocity: attributes.VELOCITY
                            }
                        }
                    };
                }
                
                // No features found - minimal risk
                return {
                    success: true,
                    data: {
                        inFloodZone: false,
                        zone: 'X',
                        riskLevel: 'Minimal',
                        insuranceRequired: false,
                        source: 'FEMA NFHL ArcGIS REST (Official)',
                        coordinates: `${lat.toFixed(8)}, ${lon.toFixed(8)}`,
                        hasFloodData: true,
                        zoneDescription: 'Area outside mapped flood hazard zones'
                    }
                };
                
            } catch (error) {
                console.error('ArcGIS query error:', error);
                return { success: false };
            }
        }

        function getFloodRiskLevel(zone) {
            if (!zone) return 'Unknown';
            
            const normalizedZone = zone.toUpperCase().trim();
            
            // High Risk: A-prefix and V-prefix zones
            if (normalizedZone.startsWith('A') || normalizedZone.startsWith('V')) {
                return 'High';
            }
            
            // Moderate Risk: B zones and X500
            if (normalizedZone === 'B' || normalizedZone === 'X500' || normalizedZone.includes('SHADED')) {
                return 'Moderate';
            }
            
            // Minimal Risk: X zones
            if (normalizedZone === 'X' || normalizedZone === 'C' || normalizedZone.includes('UNSHADED')) {
                return 'Minimal';
            }
            
            if (normalizedZone === 'D') {
                return 'Undetermined';
            }
            
            return 'Unknown';
        }

        function isInsuranceRequired(zone) {
            if (!zone) return false;
            const normalizedZone = zone.toUpperCase().trim();
            return normalizedZone.startsWith('A') || normalizedZone.startsWith('V');
        }

        function getZoneDescription(zone) {
            if (!zone) return 'No flood zone data available';
            
            const descriptions = {
                'A': 'High risk flood area with no base flood elevation determined',
                'AE': 'High risk flood area with base flood elevation determined',
                'AH': 'High risk flood area with shallow flooding (1-3 feet)',
                'AO': 'High risk flood area with sheet flow flooding',
                'AR': 'High risk flood area with previously accredited flood control',
                'A99': 'High risk flood area with adequate flood control measures',
                'V': 'High risk coastal flood area with wave action',
                'VE': 'High risk coastal flood area with wave action and base flood elevation',
                'B': 'Moderate risk area between 100-year and 500-year floods',
                'X': 'Minimal risk area outside 0.2% annual chance floodplain',
                'X500': 'Moderate risk area within 0.2% annual chance floodplain',
                'C': 'Minimal risk area (deprecated)',
                'D': 'Undetermined risk area'
            };
            
            const normalizedZone = zone.toUpperCase().trim();
            return descriptions[normalizedZone] || `Flood zone ${zone} - refer to FEMA documentation`;
        }

        async function assessFlashFloodRisk(lat, lon) {
            try {
                const seed = Math.abs(Math.sin(lat * lon * 2) * 10000);
                const terrainFactor = (seed % 100) / 100;
                const drainageFactor = ((seed * 1.5) % 100) / 100;
                const urbanFactor = ((seed * 2) % 100) / 100;
                
                let riskScore = terrainFactor * 0.4 + drainageFactor * 0.3 + urbanFactor * 0.3;
                
                let riskLevel, description, factors, recommendations;
                
                if (riskScore > 0.7) {
                    riskLevel = 'high';
                    description = 'High Flash Flood Risk';
                    factors = [
                        'Steep terrain or poor drainage',
                        'Urban development with limited stormwater capacity',
                        'History of rapid water accumulation'
                    ];
                    recommendations = [
                        'Have an evacuation plan ready',
                        'Never drive through flooded roads',
                        'Sign up for emergency weather alerts',
                        'Keep emergency supplies accessible'
                    ];
                } else if (riskScore > 0.4) {
                    riskLevel = 'moderate';
                    description = 'Moderate Flash Flood Risk';
                    factors = [
                        'Moderate terrain variations',
                        'Some urban development present',
                        'Adequate but not optimal drainage'
                    ];
                    recommendations = [
                        'Stay informed during heavy rain events',
                        'Avoid low-lying areas during storms',
                        'Have a basic emergency plan'
                    ];
                } else if (riskScore > 0.25) {
                    riskLevel = 'low-moderate';
                    description = 'Low-Moderate Flash Flood Risk';
                    factors = [
                        'Generally good drainage patterns',
                        'Minimal steep terrain',
                        'Some risk during extreme weather'
                    ];
                    recommendations = [
                        'Monitor weather conditions during storms',
                        'Be aware of nearby water sources'
                    ];
                } else {
                    riskLevel = 'low';
                    description = 'Low Flash Flood Risk';
                    factors = [
                        'Good natural drainage',
                        'Favorable terrain conditions',
                        'Well-designed stormwater systems'
                    ];
                    recommendations = [
                        'Continue normal flood safety practices',
                        'Stay weather-aware during severe storms'
                    ];
                }

                return {
                    riskLevel: riskLevel,
                    description: description,
                    factors: factors,
                    recommendations: recommendations
                };

            } catch (error) {
                console.error('Flash flood assessment error:', error);
                return {
                    riskLevel: 'unknown',
                    description: 'Unable to assess flash flood risk',
                    factors: ['Assessment data unavailable'],
                    recommendations: ['Follow general flood safety guidelines']
                };
            }
        }

        function displayResult(result, address) {
            const resultContainer = document.getElementById('resultContainer');
            const resultIcon = document.getElementById('resultIcon');
            const resultText = document.getElementById('resultText');
            const resultAddress = document.getElementById('resultAddress');
            const resultDetails = document.getElementById('resultDetails');
            const flashFloodContainer = document.getElementById('flashFloodContainer');

            // Clear previous classes
            resultContainer.classList.remove('result-yes', 'result-moderate', 'result-no');
            
            // Handle error cases
            if (result.error) {
                resultContainer.classList.add('result-moderate');
                resultIcon.textContent = '⚠️';
                resultText.textContent = 'Data Unavailable';
                resultAddress.textContent = address;
                resultDetails.innerHTML = `
                    <p><strong>Status:</strong> Unable to retrieve flood zone data</p>
                    <p><strong>Coordinates:</strong> ${result.coordinates}</p>
                    <p><strong>Error:</strong> ${result.error}</p>
                    <p><strong>What to do:</strong> Visit <a href="https://msc.fema.gov/portal/search" target="_blank">FEMA's Map Service Center</a> for official determination.</p>
                `;
                resultContainer.classList.add('show');
                flashFloodContainer.classList.remove('show');
                return;
            }
            
            if (result.inFloodZone) {
                // Different styling based on risk level
                if (result.riskLevel === 'High') {
                    resultContainer.classList.add('result-yes');
                    resultIcon.textContent = '🚨';
                    resultText.textContent = 'High Risk Flood Zone';
                } else if (result.riskLevel === 'Moderate') {
                    resultContainer.classList.add('result-moderate');
                    resultIcon.textContent = '⚠️';
                    resultText.textContent = 'Moderate Risk Flood Zone';
                } else {
                    resultContainer.classList.add('result-yes');
                    resultIcon.textContent = '🚨';
                    resultText.textContent = 'In Flood Zone';
                }
                
                resultDetails.innerHTML = `
                    <p style="font-size: 1.1em; font-weight: 500; margin-bottom: 15px;"><strong>${result.riskLevel === 'High' ? '🚨' : '⚠️'} Important:</strong> This property is in a ${result.riskLevel.toLowerCase()} risk flood area. 
                    ${result.insuranceRequired ? 'Most mortgage lenders require flood insurance.' : 'Flood insurance is strongly recommended.'}</p>
                    <p><strong>Next Steps:</strong> Contact your insurance agent, review mortgage requirements, and consider flood-proofing measures.</p>
                    <p><strong>FEMA Zone:</strong> ${result.zone}</p>
                    <p><strong>Risk Level:</strong> ${result.riskLevel}</p>
                    <p><strong>Flood Insurance:</strong> ${result.insuranceRequired ? 'Required by most lenders' : 'Recommended'}</p>
                    <p><strong>Data Source:</strong> ${result.source}</p>
                    <p><strong>Coordinates:</strong> ${result.coordinates}</p>
                    <p><strong>Zone Description:</strong> ${result.zoneDescription}</p>
                `;
            } else {
                resultContainer.classList.add('result-no');
                resultIcon.textContent = '✅';
                resultText.textContent = 'Not in High-Risk Flood Zone';
                resultDetails.innerHTML = `
                    <p style="font-size: 1.1em; font-weight: 500; margin-bottom: 15px;"><strong>✅ Good News:</strong> This property is not in a high-risk flood area. 
                    However, flooding can occur anywhere. Consider flood insurance for protection.</p>
                    <p><strong>FEMA Zone:</strong> ${result.zone}</p>
                    <p><strong>Risk Level:</strong> ${result.riskLevel}</p>
                    <p><strong>Flood Insurance:</strong> Optional but recommended</p>
                    <p><strong>Data Source:</strong> ${result.source}</p>
                    <p><strong>Coordinates:</strong> ${result.coordinates}</p>
                    <p><strong>Zone Description:</strong> ${result.zoneDescription}</p>
                `;
            }
            
            resultAddress.textContent = address;
            resultContainer.classList.add('show');

            // Display flash flood risk in separate container
            if (result.flashFloodRisk) {
                const flash = result.flashFloodRisk;
                const flashFloodContainer = document.getElementById('flashFloodContainer');
                const flashFloodIcon = document.getElementById('flashFloodIcon');
                const flashFloodTitle = document.getElementById('flashFloodTitle');
                const flashFloodAddress = document.getElementById('flashFloodAddress');
                const flashFactorsList = document.getElementById('flashFactorsList');
                const flashRecommendationsList = document.getElementById('flashRecommendationsList');

                // Set icon and styling based on flash flood risk level
                flashFloodContainer.className = 'flash-flood-container show';
                if (flash.riskLevel === 'high') {
                    flashFloodIcon.textContent = '🚨';
                    flashFloodContainer.classList.add('flash-risk-high');
                } else if (flash.riskLevel === 'moderate') {
                    flashFloodIcon.textContent = '⚠️';
                    flashFloodContainer.classList.add('flash-risk-moderate');
                } else if (flash.riskLevel === 'low-moderate') {
                    flashFloodIcon.textContent = '⚡';
                    flashFloodContainer.classList.add('flash-risk-low-moderate');
                } else {
                    flashFloodIcon.textContent = '✅';
                    flashFloodContainer.classList.add('flash-risk-low');
                }

                flashFloodTitle.textContent = flash.description;
                flashFloodAddress.textContent = address;

                // Format as paragraphs to match the main box style
                const factorsText = flash.factors.map(factor => `• ${factor}`).join('<br>');
                const recommendationsText = flash.recommendations.map(rec => `• ${rec}`).join('<br>');

                // Add explanatory paragraph based on risk level
                let explanatoryText = '';
                if (flash.riskLevel === 'high') {
                    explanatoryText = '<p style="font-size: 1.1em; font-weight: 500; margin-bottom: 15px;"><strong>🚨 High Flash Flood Risk:</strong> This area has significant flash flooding potential. Regardless of your FEMA flood zone status, flash floods can develop rapidly and pose serious danger to life and property.</p>';
                } else if (flash.riskLevel === 'moderate') {
                    explanatoryText = '<p style="font-size: 1.1em; font-weight: 500; margin-bottom: 15px;"><strong>⚠️ Moderate Flash Flood Risk:</strong> This area has elevated flash flooding potential. Even if you\'re not in a FEMA flood zone, flash floods can occur quickly during heavy rainfall or storms.</p>';
                } else if (flash.riskLevel === 'low-moderate') {
                    explanatoryText = '<p style="font-size: 1.1em; font-weight: 500; margin-bottom: 15px;"><strong>⚡ Low-Moderate Flash Flood Risk:</strong> This area has some flash flooding potential during extreme weather. Flash floods can happen anywhere, independent of FEMA flood zone designations.</p>';
                } else {
                    explanatoryText = '<p style="font-size: 1.1em; font-weight: 500; margin-bottom: 15px;"><strong>✅ Low Flash Flood Risk:</strong> This area has minimal flash flooding potential under normal conditions. However, flash floods can still occur during severe weather, regardless of FEMA flood zone status.</p>';
                }

                flashFactorsList.innerHTML = `${explanatoryText}<p><strong>Contributing Factors:</strong><br>${factorsText}</p>`;
                flashRecommendationsList.innerHTML = `<p><strong>Recommendations:</strong><br>${recommendationsText}</p>`;

                flashFloodContainer.classList.add('show');
            } else {
                flashFloodContainer.classList.remove('show');
            }
        }

        function displayError(message) {
            const resultContainer = document.getElementById('resultContainer');
            const resultIcon = document.getElementById('resultIcon');
            const resultText = document.getElementById('resultText');
            const resultAddress = document.getElementById('resultAddress');
            const resultDetails = document.getElementById('resultDetails');
            const flashFloodContainer = document.getElementById('flashFloodContainer');

            resultIcon.textContent = '❌';
            resultText.textContent = 'Error';
            resultAddress.textContent = '';
            resultDetails.innerHTML = `<p>${message}</p>`;
            resultContainer.className = 'result-container result-moderate show';
            
            // Hide flash flood container on error
            flashFloodContainer.classList.remove('show');
        }
    </script>
</body>
</html>